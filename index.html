<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Werewolf Pro - Automated Night</title>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  
  <style>
    body { background: #1a1a2e; color: white; font-family: sans-serif; text-align: center; margin: 0; padding: 20px; transition: background 1s; }
    .hidden { display: none !important; }
    .panel { background: #16213e; padding: 20px; border-radius: 15px; max-width: 450px; margin: 20px auto; border: 1px solid #4e9af1; position: relative; }
    button { padding: 12px 24px; cursor: pointer; background: #e94560; color: white; border: none; border-radius: 5px; font-weight: bold; margin: 5px; }
    
    #roomSticky { position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 5px 15px; border-radius: 20px; border: 1px solid #4e9af1; font-size: 0.8rem; z-index: 100; }
    .player-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #0f3460; font-size: 0.9rem; }
    
    .card { width: 160px; height: 220px; background: #0f3460; border: 3px solid #e94560; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; margin: 20px auto; cursor: pointer; }
    .night-mode { background: #050510 !important; }
    
    #timerDisplay { font-size: 3rem; font-weight: bold; color: #e94560; margin: 10px 0; }
    .turn-announcement { font-size: 1.5rem; color: #4e9af1; margin-bottom: 10px; }
  </style>
</head>
<body>

  <div id="roomSticky" class="hidden">ROOM: <span id="stickyCode">----</span></div>

  <div id="landingPanel" class="panel">
    <h1>WEREWOLF</h1>
    <button onclick="createGame()">Create New Game</button>
    <input type="text" id="joinCode" placeholder="Room Code" style="padding:10px; width:60%;">
    <button onclick="joinGame()">Join</button>
  </div>

  <div id="lobbyPanel" class="panel hidden">
    <h2 id="roomBadge">----</h2>
    <div id="hostControls" class="hidden">
      <button onclick="assignRolesAndStart()">DEAL & START GAME</button>
    </div>
    <div id="playerList"></div>
  </div>

  <div id="gamePanel" class="panel hidden">
    <div id="timerDisplay" class="hidden">60</div>
    <div id="turnInfo" class="turn-announcement">Waiting for Host...</div>

    <div id="roleView">
      <div class="card" id="myRoleCard" onclick="revealRoleOnCard()">TAP ROLE</div>
    </div>

    <div id="hostNightTools" class="hidden">
      <hr>
      <button id="nightBtn" onclick="startNightSequence()">üåô START NIGHT FALL</button>
      <button onclick="resetGame()">RESET ROOM</button>
      <div id="hostGodView"></div>
    </div>
  </div>

  <script>
    const firebaseConfig = { apiKey: "AIzaSyCjdJYEjdZb-5OQxyBYSfXxVD9y5aaCh64",
  authDomain: "werewolfgame-7386c.firebaseapp.com",
  databaseURL: "https://werewolfgame-7386c-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "werewolfgame-7386c",
  storageBucket: "werewolfgame-7386c.firebasestorage.app",
  messagingSenderId: "37154052928",
  appId: "1:37154052928:web:ea8671e645f8cbf62038a5",
  measurementId: "G-1VYE9RRKVJ" };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let currentRoom = null, myPlayerId = null, isHost = false, currentRole = "Unknown", timerInt;

    // --- VOICE HELPER ---
    function speak(text) {
      window.speechSynthesis.cancel();
      const msg = new SpeechSynthesisUtterance(text);
      msg.rate = 0.9; msg.pitch = 0.8;
      window.speechSynthesis.speak(msg);
    }

    // --- CORE LOGIC ---
    function setupListeners(code) {
      document.getElementById('roomSticky').classList.remove('hidden');
      document.getElementById('stickyCode').innerText = code;
      
      database.ref('rooms/' + code).on('value', (snap) => {
        const data = snap.val();
        if (!data) return;

        if (data.status === "LOBBY") {
          showPanel('lobbyPanel');
          updatePlayerList(data.players);
        } else {
          showPanel('gamePanel');
          handleNightCycle(data.nightPhase, data.players[myPlayerId].role);
          if (isHost) updateHostGodView(data.players);
        }
      });
    }

    function handleNightCycle(phase, myRole) {
      const turnInfo = document.getElementById('turnInfo');
      const timerDiv = document.getElementById('timerDisplay');
      
      if (!phase || phase === "IDLE") {
        turnInfo.innerText = "It is currently Day time.";
        timerDiv.classList.add('hidden');
        return;
      }

      timerDiv.classList.remove('hidden');
      
      // Highlight UI if it is my turn
      if (myRole === phase || (myRole === "WEREWOLF" && phase === "WEREWOLVES")) {
        turnInfo.innerHTML = `‚≠ê <b style="color:white">YOUR TURN: ${phase}</b> ‚≠ê`;
        document.body.style.border = "5px solid #e94560";
      } else {
        turnInfo.innerText = `${phase} are acting...`;
        document.body.style.border = "none";
      }

      // Sync local timer with the start timestamp from Firebase
      database.ref(`rooms/${currentRoom}/phaseEndTime`).on('value', (tSnap) => {
        const endTime = tSnap.val();
        updateLocalTimer(endTime);
      });
    }

    function updateLocalTimer(endTime) {
      clearInterval(timerInt);
      timerInt = setInterval(() => {
        const now = Date.now();
        const diff = Math.ceil((endTime - now) / 1000);
        document.getElementById('timerDisplay').innerText = diff > 0 ? diff : 0;
        if (diff <= 0) clearInterval(timerInt);
      }, 1000);
    }

    // --- HOST ACTIONS ---
    async function startNightSequence() {
      // 1. Initial Night Fall
      speak("The sun sets. Everyone, close your eyes.");
      await setPhase("WEREWOLVES", 60);
      speak("Werewolves, wake up and choose your victim.");

      // Set timeouts to trigger next voices/phases automatically
      setTimeout(async () => {
        speak("Werewolves, go to sleep. Seer, wake up.");
        await setPhase("SEER", 30);
      }, 61000);

      setTimeout(async () => {
        speak("Seer, go to sleep. Witch, wake up.");
        await setPhase("WITCH", 30);
      }, 92000);

      setTimeout(async () => {
        speak("Witch, go to sleep. Hunter, wake up.");
        await setPhase("HUNTER", 3);
      }, 123000);

      setTimeout(async () => {
        speak("Everyone, wake up. The sun is rising.");
        await setPhase("IDLE", 0);
      }, 127000);
    }

    async function setPhase(phaseName, durationSeconds) {
      const endTime = Date.now() + (durationSeconds * 1000);
      await database.ref(`rooms/${currentRoom}`).update({
        nightPhase: phaseName,
        phaseEndTime: endTime
      });
    }

    // --- REUSE BASELINE FUNCTIONS (Simplified) ---
    function createGame() {
      const code = Math.random().toString(36).substring(2, 6).toUpperCase();
      isHost = true;
      database.ref('rooms/' + code).set({ status: "LOBBY" }).then(() => addPlayerToRoom(code, "Host"));
    }

    function joinGame() {
      const code = document.getElementById('joinCode').value.toUpperCase();
      database.ref('rooms/' + code).once('value', (snap) => {
        if (snap.exists()) addPlayerToRoom(code, prompt("Name:"));
      });
    }

    function addPlayerToRoom(code, name) {
      currentRoom = code;
      const ref = database.ref(`rooms/${code}/players`).push();
      myPlayerId = ref.key;
      ref.set({ name, role: "Villager", status: "ALIVE" });
      setupListeners(code);
    }

    function showPanel(id) {
      document.querySelectorAll('.panel').forEach(p => p.classList.add('hidden'));
      document.getElementById(id).classList.remove('hidden');
      if (isHost && id === 'gamePanel') document.getElementById('hostNightTools').classList.remove('hidden');
    }

    function assignRolesAndStart() {
      database.ref(`rooms/${currentRoom}`).update({ status: "PLAYING", nightPhase: "IDLE" });
    }

    function revealRoleOnCard() {
      database.ref(`rooms/${currentRoom}/players/${myPlayerId}/role`).once('value', s => {
        document.getElementById('myRoleCard').innerText = s.val();
      });
    }

    function updatePlayerList(players) { /* Same as baseline */ }
    function updateHostGodView(players) { /* Same as baseline */ }
    function resetGame() { database.ref(`rooms/${currentRoom}`).update({ status: "LOBBY", nightPhase: "IDLE" }); }
  </script>
</body>
</html>
