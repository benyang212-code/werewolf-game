<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Werewolf Pro - Secure Host</title>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  
  <style>
    body { background: #1a1a2e; color: white; font-family: sans-serif; text-align: center; margin: 0; padding: 20px; transition: background 1s; }
    .hidden { display: none !important; }
    .panel { background: #16213e; padding: 20px; border-radius: 15px; max-width: 450px; margin: 20px auto; border: 1px solid #4e9af1; position: relative; }
    input, select { padding: 10px; border-radius: 5px; border: none; margin: 10px 0; width: 80%; background: #0f3460; color: white; }
    button { padding: 12px 24px; cursor: pointer; background: #e94560; color: white; border: none; border-radius: 5px; font-weight: bold; margin: 5px; }
    
    #roomSticky { position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 5px 15px; border-radius: 20px; border: 1px solid #4e9af1; font-size: 0.8rem; z-index: 100; }
    .leave-btn { background: #555; font-size: 0.7rem; position: fixed; top: 10px; right: 10px; padding: 8px 15px; border-radius: 20px; z-index: 100; }
    
    .player-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #0f3460; font-size: 0.9rem; }
    .dead { text-decoration: line-through; color: #ff4d6d !important; opacity: 0.6; }
    
    .card { width: 180px; height: 260px; background: #0f3460; border: 3px solid #e94560; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin: 20px auto; cursor: pointer; }
    .night-mode { background: #050510 !important; }
    
    .host-btn-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; margin-top: 10px; }
    .btn-secondary { background: #4e9af1; font-size: 0.8rem; }
    .btn-danger { background: #555; font-size: 0.8rem; }
    
#phaseBar { display:flex; justify-content:center; align-items:center; gap:10px; margin: 10px 0; }
#phaseLabel { font-weight: 700; letter-spacing: 0.5px; }
#phaseCountdown { font-variant-numeric: tabular-nums; background:#0f3460; padding:4px 10px; border-radius:12px; border:1px solid #4e9af1; }
.role-action { margin-top: 10px; }
.small-note { font-size: 0.85rem; opacity: 0.8; }
.hidden-inline { display:none; }

/* --- Phase & action UI --- */
#phaseBar { display:flex; justify-content:center; align-items:center; gap:10px; margin: 10px 0; }
#phaseLabel { font-weight: 700; letter-spacing: 0.5px; }
#phaseCountdown { font-variant-numeric: tabular-nums; background:#0f3460; padding:4px 10px; border-radius:12px; border:1px solid #4e9af1; }
.role-action { margin-top: 10px; }
.small-note { font-size: 0.85rem; opacity: 0.8; }
.hidden-inline { display:none; }


  </style>
</head>
<body>

  <div id="roomSticky" class="hidden">ROOM: <span id="stickyCode">----</span></div>
  <button id="leaveBtn" class="leave-btn hidden" onclick="leaveGame()">LEAVE</button>

  <div id="landingPanel" class="panel">
    <h1>WEREWOLF</h1>
    <button onclick="createGame()">Create New Game</button>
    <hr style="border: 0; border-top: 1px solid #4e9af1; margin: 20px 0;">
    <input type="text" id="joinCode" placeholder="Enter 4-Letter Code">
    <button onclick="joinGame()">Join Game</button>
  </div>

  <div id="lobbyPanel" class="panel hidden">
    <h2>LOBBY</h2>
    <div id="roomBadge" style="font-size: 2rem; color: #4e9af1; letter-spacing: 3px;">----</div>
    
    <div id="hostControls" class="hidden">
      <div style="text-align: left; display: inline-block; margin: 15px 0;">
        <label>Wolves: <select id="wolfCount" style="width: 50px;"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></label><br>
        <label><input type="checkbox" id="includeSeer" checked> Seer</label><br>
        <label><input type="checkbox" id="includeWitch" checked> Witch</label><br>
        <label><input type="checkbox" id="includeHunter" checked> Hunter</label><br>
        <label><input type="checkbox" id="hostIsPlaying" checked> Host is Playing</label>
      </div><br>
      <button onclick="assignRolesAndStart()">DEAL & START</button>
    </div>

    <div id="playerStatus" class="hidden"><h3>Waiting for host...</h3></div>
    <hr style="border: 0; border-top: 1px solid #4e9af1;">
    <div id="playerList"></div>
  </div>

  <div id="gamePanel" class="panel hidden">
    <div id="roleView">
      <h2 id="gameStatus">Your Role</h2>
      <div class="card" id="myRoleCard">TAP & HOLD</div>
    </div>
    <div id="actionPanel" class="panel hidden" style="margin-top:10px;">
      <!-- Will be rendered dynamically per phase & role -->
    </div>
    <div id="deadMessage" class="hidden">
      <h1 style="color: #e94560;">YOU ARE DEAD</h1>
    </div>
    
    <div id="hostDashboard" class="hidden">
      <hr>
      <h3>Host Tools</h3>
        <div id="phaseBar">
          <span id="phaseLabel">—</span>
          <span id="phaseCountdown">—</span>
        </div>
      
      <div class="host-btn-group">
        <button class="btn-secondary" onclick="toggleRoleVisibility()">Show/Hide Secret Roles</button>
        <button class="btn-danger" onclick="resetGame()">Reset Room</button>    
        <button class="btn-secondary" onclick="startNight()">Nightfall</button>
        <button class="btn-danger" onclick="toggleVoice()"><span id="voiceState">Voice: On</span></button>

      </div>
      <div id="hostPlayerList" style="margin-top: 15px;"></div>
    </div>
  </div>

  <script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyCjdJYEjdZb-5OQxyBYSfXxVD9y5aaCh64",
      authDomain: "werewolfgame-7386c.firebaseapp.com",
      databaseURL: "https://werewolfgame-7386c-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "werewolfgame-7386c",
      storageBucket: "werewolfgame-7386c.firebasestorage.app",
      messagingSenderId: "37154052928",
      appId: "1:37154052928:web:ea8671e645f8cbf62038a5",
      measurementId: "G-1VYE9RRKVJ"
    };
    firebase.initializeApp(firebaseConfig);
    
    // Sync to Firebase server time for accurate countdowns
    firebase.database().ref('/.info/serverTimeOffset').on('value', s => {
      serverOffset = s.val() || 0;
    });

    const database = firebase.database();

    let currentRoom = null, myPlayerId = null, isHost = false, currentRole = "Unknown", rolesVisible = false;

    // --- PHASE / TIMER / VOICE / ACTION---
    let phase = { name: '', endsAt: 0, night: 0 };
    let serverOffset = 0;
    let timerInterval = null;
    let voiceOn = true;
    let lastPlayers = {}; // cache of players for action UIs
    let actionRef = null;       // live listener for current phase actions
    let resolvingLock = false;  // prevent double advance

    const PHASES = ['NIGHTFALL', 'WOLVES', 'SEER', 'WITCH', 'HUNTER', 'DAY'];
    const PHASE_DUR_MS = {
      NIGHTFALL: 3000,
      WOLVES: 60000,   // 60s
      SEER: 30000,     // 30s
      WITCH: 30000,    // 30s
      HUNTER: 3000,    // 3s
      DAY: 0
    };
    function now() { return Date.now() + serverOffset; }
    
    window.onload = () => {
      const savedRoom = localStorage.getItem('werewolf_room');
      const savedId = localStorage.getItem('werewolf_id');
      const savedHost = localStorage.getItem('werewolf_isHost');
      if (savedRoom && savedId) {
        currentRoom = savedRoom; myPlayerId = savedId;
        isHost = (savedHost === "true");
        setupListeners(savedRoom);
      }
    };

    function createGame() {
      const code = Math.random().toString(36).substring(2, 6).toUpperCase();
      const name = prompt("Enter host name:");
      if (!name) return;
      isHost = true; localStorage.setItem('werewolf_isHost', "true");
      database.ref('rooms/' + code).set({ status: "LOBBY" }).then(() => addPlayerToRoom(code, name));
    }

    function joinGame() {
      const code = document.getElementById('joinCode').value.toUpperCase();
      const name = prompt("Enter your name:");
      if (!name || !code) return;
      database.ref('rooms/' + code).once('value', (snap) => {
        if (snap.exists()) addPlayerToRoom(code, name);
        else alert("Room not found!");
      });
    }

    function addPlayerToRoom(code, name) {
      currentRoom = code;
      const playersRef = database.ref('rooms/' + code + '/players');
      playersRef.once('value', (snap) => {
        const seatNum = (snap.numChildren() || 0) + 1;
        const playerRef = playersRef.push();
        myPlayerId = playerRef.key;
        localStorage.setItem('werewolf_room', code);
        localStorage.setItem('werewolf_id', myPlayerId);
        playerRef.set({ name: name, seat: seatNum, role: "Waiting...", status: "ALIVE" });
        setupListeners(code);
      });
    }

    function setupListeners(code) {
      document.getElementById('roomBadge').innerText = code;
      document.getElementById('stickyCode').innerText = code;
      document.getElementById('roomSticky').classList.remove('hidden');
      document.getElementById('landingPanel').classList.add('hidden');
      document.getElementById('leaveBtn').classList.remove('hidden');

      database.ref('rooms/' + code).on('value', (snap) => {
        const data = snap.val();
        if (!data) return;

        if (data.status === "LOBBY") {
          document.getElementById('lobbyPanel').classList.remove('hidden');
          document.getElementById('gamePanel').classList.add('hidden');
          document.body.classList.remove('night-mode');
          if (isHost) document.getElementById('hostControls').classList.remove('hidden');
          else document.getElementById('playerStatus').classList.remove('hidden');
        } else {
          document.getElementById('lobbyPanel').classList.add('hidden');
          document.getElementById('gamePanel').classList.remove('hidden');
          document.body.classList.add('night-mode');
          if (isHost) document.getElementById('hostDashboard').classList.remove('hidden');
          
          const me = data.players[myPlayerId];
          currentRole = me.role;
          if (me.status === "DEAD") {
            document.getElementById('roleView').classList.add('hidden');
            document.getElementById('deadMessage').classList.remove('hidden');
          } else {
            document.getElementById('roleView').classList.toggle('hidden', me.role === "MODERATOR");
            document.getElementById('deadMessage').classList.add('hidden');
          }
        }
        updatePlayerUI(data.players);
      });
      
      // Listen for phase changes
      database.ref(`rooms/${code}/phase`).on('value', snap => {
        phase = snap.val() || { name: '', endsAt: 0, night: 0 };
        updatePhaseUI();
        bindActionsListener(); // watch players' confirmations & actions for early completion
      });

    }

    function updatePlayerUI(players) {
      lastPlayers = players || {}; // <--- add this line
      const listDiv = document.getElementById('playerList');
      const hostDiv = document.getElementById('hostPlayerList');
      listDiv.innerHTML = "<h4>Players Joined:</h4>";
      hostDiv.innerHTML = "";
      for (let id in players) {
        const p = players[id];
        listDiv.innerHTML += `<div class="player-row ${p.status === 'DEAD' ? 'dead' : ''}">
          <span>Seat ${p.seat}: ${p.name}</span>
        </div>`;
        if (isHost) {
          const roleDisplay = rolesVisible ? p.role : "???";
          hostDiv.innerHTML += `<div class="player-row">
            <span>${p.name} (${roleDisplay})</span>
            <button class="btn-secondary" style="padding:5px;" onclick="toggleLife('${id}', '${p.status}')">
              ${p.status === 'ALIVE' ? 'Kill' : 'Revive'}
            </button>
          </div>`;
        }
      }
    }
    
    function updatePhaseUI() {
      // Phase label
      const lbl = document.getElementById('phaseLabel');
      const cd = document.getElementById('phaseCountdown');
      if (lbl) lbl.innerText = phase.name ? `${phase.name} (N${phase.night || 0})` : '—';
    
      // Timer
      if (timerInterval) { clearInterval(timerInterval); timerInterval = null; }
      if (phase && phase.endsAt && phase.endsAt > 0) {
        const tick = () => {
          const remain = Math.max(0, Math.round((phase.endsAt - now()) / 1000));
          if (cd) cd.innerText = `${remain}s`;
          if (remain <= 0) {
            clearInterval(timerInterval);
            timerInterval = null;
            // Host auto-advances to next phase
            if (isHost) await tryAdvance(); // time's up -> advance
          }
        };
        tick();
        timerInterval = setInterval(tick, 250);
      } else {
        if (cd) cd.innerText = '—';
      }
      renderRoleActionPanel();
    }
    
    function toggleVoice() {
      voiceOn = !voiceOn;
      const el = document.getElementById('voiceState');
      if (el) el.innerText = `Voice: ${voiceOn ? 'On' : 'Off'}`;
    }
    
    function announcePhase(name) {
      if (!voiceOn || !('speechSynthesis' in window)) return;
      const lines = {
        NIGHTFALL: 'Night falls. Everyone close your eyes.',
        WOLVES:    'Wolves, open your eyes and choose a victim.',
        SEER:      'Seer, open your eyes and divine one player.',
        WITCH:     'Witch, you may save or poison one player.',
        HUNTER:    'Hunter, if you are dying, take your shot.',
        DAY:       'Day breaks. Everyone open your eyes.'
      };
      const u = new SpeechSynthesisUtterance(lines[name] || name);
      u.rate = 0.95; u.pitch = 1; u.lang = 'en-AU';
      try { speechSynthesis.cancel(); speechSynthesis.speak(u); } catch (e) {}
    }
    
        
    function setPhase(name, durMs, night) {
      resolvingLock = false;
      const endsAt = durMs > 0 ? now() + durMs : 0;
      database.ref(`rooms/${currentRoom}/phase`).set({ name, night, endsAt });
      if (isHost) announcePhase(name);
    }
    
    function startNight() {
      if (!isHost) return;
      const nextNight = (phase.night || 0) + 1;
      setPhase('NIGHTFALL', PHASE_DUR_MS.NIGHTFALL, nextNight);
    }
    
    async function isPhaseComplete() {
      // Completion = required confirms exist for the current phase.
      const night = phase.night;
      if (!night) return false;
    
      const actSnap = await database.ref(`rooms/${currentRoom}/actions/night_${night}`).once('value');
      const acts = actSnap.val() || {};
    
      // Build helper: count alive wolves
      const playersSnap = await database.ref(`rooms/${currentRoom}/players`).once('value');
      const players = playersSnap.val() || {};
      const alive = Object.keys(players).filter(id => players[id].status === 'ALIVE');
      const aliveWolves = alive.filter(id => players[id].role === 'WEREWOLF');
    
      if (phase.name === 'WOLVES') {
        const conf = acts?.wolves?.confirm || {};
        const votes = acts?.wolves?.votes || {};
        const allConfirmed = aliveWolves.every(id => conf[id]);
        const hasAtLeastOneVote = Object.keys(votes).length > 0;
        return allConfirmed && hasAtLeastOneVote;
      }
      if (phase.name === 'SEER') {
        const conf = acts?.seer?.confirm || {};
        // Exactly one seer in deck (if present); consider complete when any seer confirms
        return Object.keys(conf).length > 0;
      }
      if (phase.name === 'WITCH') {
        const conf = acts?.witch?.confirm || {};
        return Object.keys(conf).length > 0;
      }
      if (phase.name === 'HUNTER') {
        const conf = acts?.hunter?.confirm || {};
        return Object.keys(conf).length > 0;
      }
      if (phase.name === 'NIGHTFALL') {
        // No action; allow early skip if needed (not required)
        return false;
      }
      return false;
    }

    async function advancePhase() {
      //if (!isHost) return;
      // Before moving on, resolve the current phase if needed:
      if (phase.name === 'WOLVES') {
        await computeWolvesVictim(phase.night);
      } else if (phase.name === 'WITCH') {
        // Resolve night deaths (save/poison) and set hunterPending if any
        const hunterPending = await resolveNight(phase.night);
        if (hunterPending) {
          setPhase('HUNTER', PHASE_DUR_MS.HUNTER, phase.night);
          return;
        } else {
          setPhase('DAY', PHASE_DUR_MS.DAY, phase.night);
          return;
        }
      } else if (phase.name === 'HUNTER') {
        await resolveHunter(phase.night);
        setPhase('DAY', PHASE_DUR_MS.DAY, phase.night);
        return;
      }
    
      // Default move to the next phase in the sequence
      const idx = Math.max(0, PHASES.indexOf(phase.name));
      let next = PHASES[(idx + 1) % PHASES.length];
      let night = phase.night || 1;
      
      if (phase.name === 'NIGHTFALL') next = 'WOLVES';
      if (phase.name === 'DAY') { // Starting a new cycle
        next = 'NIGHTFALL';
        night += 1;
      }
    
      setPhase(next, PHASE_DUR_MS[next], night);
    }
    
    async function computeWolvesVictim(night) {
      const snap = await database.ref(`rooms/${currentRoom}/actions/night_${night}/wolves`).once('value');
      const votes = snap.val() || {};
      const tally = {};
      Object.values(votes).forEach(t => { if (t) tally[t] = (tally[t] || 0) + 1; });
    
      let victim = null, max = -1;
      for (const [id, count] of Object.entries(tally)) {
        if (count > max) { max = count; victim = id; }
      }
      await database.ref(`rooms/${currentRoom}/state`).update({ pendingVictim: victim || null });
    }
    
    async function resolveNight(night) {
      const stateSnap = await database.ref(`rooms/${currentRoom}/state`).once('value');
      const state = stateSnap.val() || {};
      let victim = state.pendingVictim || null;
    
      const witchSnap = await database.ref(`rooms/${currentRoom}/actions/night_${night}/witch`).once('value');
      const witch = witchSnap.val() || {};
      if (witch.save === true) victim = null;
    
      const poisonTarget = witch.poisonTarget || null;
    
      // Determine if Hunter is among the dead this night
      let hunterPending = null;
      async function roleOf(id) {
        if (!id) return null;
        const r = await database.ref(`rooms/${currentRoom}/players/${id}/role`).once('value');
        return r.val();
      }
      const victimRole = victim ? await roleOf(victim) : null;
      const poisonRole = poisonTarget ? await roleOf(poisonTarget) : null;
      if (victim && victimRole === 'HUNTER') hunterPending = victim;
      if (poisonTarget && poisonRole === 'HUNTER') hunterPending = poisonTarget;
    
      const updates = {};
      if (victim) updates[`rooms/${currentRoom}/players/${victim}/status`] = 'DEAD';
      if (poisonTarget) updates[`rooms/${currentRoom}/players/${poisonTarget}/status`] = 'DEAD';
    
      if (Object.keys(updates).length) await database.ref().update(updates);
      await database.ref(`rooms/${currentRoom}/state`).update({
        pendingVictim: null,
        lastNight: night,
        hunterPending: hunterPending || null
      });
    
      return hunterPending;
    }
    
    async function resolveHunter(night) {
      const actSnap = await database.ref(`rooms/${currentRoom}/actions/night_${night}/hunter`).once('value');
      const act = actSnap.val() || {};
      const target = act.target;
      if (target) {
        await database.ref(`rooms/${currentRoom}/players/${target}/status`).set('DEAD');
      }
      await database.ref(`rooms/${currentRoom}/state/hunterPending`).set(null);
    }
    
    function bindActionsListener() {
      if (actionRef) { actionRef.off(); actionRef = null; }
      if (!currentRoom || !phase?.night) return;
    
      // Watch all actions for this night
      actionRef = database.ref(`rooms/${currentRoom}/actions/night_${phase.night}`);
      actionRef.on('value', async (snap) => {
        if (!isHost) return;
        await tryAdvance(true); // check if we can advance early (on confirmations)
      });
    }
    
    async function tryAdvance(early=false) {
      if (resolvingLock) return;
      // Only host advances
      if (!isHost) return;
    
      // If early==true, only advance when role confirms; if timer==0, advance regardless.
      if (early) {
        const complete = await isPhaseComplete();
        if (!complete) return;
      }
    
      resolvingLock = true;
      await advancePhase(); // internal advance with resolution logic
      resolvingLock = false;
    }
    
    function renderRoleActionPanel() {
      const panel = document.getElementById('actionPanel');
      if (!panel) return;
      panel.innerHTML = '';
      panel.classList.add('hidden');
    
      const me = lastPlayers?.[myPlayerId];
      if (!me || me.status === 'DEAD') return;
    
      const aliveIds = Object.keys(lastPlayers).filter(id => lastPlayers[id].status === 'ALIVE');
    
      // Wolves
      if (phase.name === 'WOLVES' && me.role === 'WEREWOLF') {
        panel.classList.remove('hidden');
        panel.innerHTML = `
          <h3>Wolves</h3>
          <div class="small-note">Choose a victim, then Confirm.</div>
          <div class="role-action">
            <select id="wolfTarget">
              ${aliveIds.map(id => `<option value="${id}">${lastPlayers[id].name}</option>`).join('')}
            </select>
            <button onclick="submitWolfVote()">Vote</button>
            <button onclick="confirmRoleDone()">Confirm</button>
          </div>
        `;
      }
    
      // Seer
      if (phase.name === 'SEER' && me.role === 'SEER') {
        panel.classList.remove('hidden');
        panel.innerHTML = `
          <h3>Seer</h3>
          <div class="small-note">Reveal one player, then Confirm (or Skip).</div>
          <div class="role-action">
            <select id="seerTarget">
              ${aliveIds.map(id => `<option value="${id}">${lastPlayers[id].name}</option>`).join('')}
            </select>
            <button onclick="seerDivine()">Reveal</button>
            <button onclick="confirmRoleDone()">Confirm</button>
            <button onclick="confirmRoleSkip()">Skip & Confirm</button>
          </div>
          <div id="seerResult" style="margin-top:6px;color:#4e9af1;"></div>
        `;
      }
    
      // Witch
      if (phase.name === 'WITCH' && me.role === 'WITCH') {
        panel.classList.remove('hidden');
        panel.innerHTML = `
          <h3>Witch</h3>
          <div class="small-note">Save the victim, poison someone, or do nothing. Then Confirm.</div>
          <div class="role-action">
            <button onclick="witchSave()">Save</button>
            <button onclick="witchPoison()">Poison</button>
            <button onclick="witchNone()">Do Nothing</button>
          </div>
          <div id="witchNote" class="small-note" style="margin-top:6px;"></div>
          <div id="poisonUI" class="hidden" style="margin-top:6px;">
            <select id="witchTarget">
              ${aliveIds.map(id => `<option value="${id}">${lastPlayers[id].name}</option>`).join('')}
            </select>
            <button onclick="confirmWitchPoison()">Confirm Poison</button>
          </div>
          <div class="role-action">
            <button onclick="confirmRoleDone()">Confirm</button>
          </div>
        `;
      }
    
      // Hunter
      if (phase.name === 'HUNTER' && me.role === 'HUNTER') {
        panel.classList.remove('hidden');
        panel.innerHTML = `
          <h3>Hunter</h3>
          <div class="small-note">Shoot quickly or skip, then Confirm.</div>
          <div class="role-action">
            <select id="hunterTarget">
              ${aliveIds.filter(id => id !== myPlayerId).map(id => `<option value="${id}">${lastPlayers[id].name}</option>`).join('')}
            </select>
            <button onclick="hunterShoot()">Shoot</button>
            <button onclick="confirmRoleSkip()">Skip</button>
            <button onclick="confirmRoleDone()">Confirm</button>
          </div>
        `;
      }
    }
    
    // --- Action writers ---
    function submitWolfVote() {
      const target = document.getElementById('wolfTarget').value;
      database.ref(`rooms/${currentRoom}/actions/night_${phase.night}/wolves/${myPlayerId}`).set(target);
    }
    
    function confirmRoleDone() {
      database.ref(`rooms/${currentRoom}/actions/night_${phase.night}/${phase.name.toLowerCase()}/confirm/${myPlayerId}`).set(true);
    }
    
    function confirmRoleSkip() {
      database.ref(`rooms/${currentRoom}/actions/night_${phase.night}/${phase.name.toLowerCase()}/skip/${myPlayerId}`).set(true);
      confirmRoleDone();
    }
    
    function seerDivine() {
      const target = document.getElementById('seerTarget').value;
      const role = lastPlayers[target]?.role || 'Unknown';
      database.ref(`rooms/${currentRoom}/actions/night_${phase.night}/seer/${myPlayerId}`).set(target);
      const res = document.getElementById('seerResult');
      if (res) res.innerText = `${lastPlayers[target].name} is ${role}.`;
    }
    
    function witchSave() {
      database.ref(`rooms/${currentRoom}/actions/night_${phase.night}/witch/save`).set(true);
      const note = document.getElementById('witchNote');
      if (note) note.innerText = 'You chose to save the victim.';
    }
    
    function witchPoison() {
      const ui = document.getElementById('poisonUI');
      if (ui) ui.classList.remove('hidden');
    }
    
    function confirmWitchPoison() {
      const t = document.getElementById('witchTarget').value;
      database.ref(`rooms/${currentRoom}/actions/night_${phase.night}/witch/poisonTarget`).set(t);
      const note = document.getElementById('witchNote');
      if (note) note.innerText = `You poisoned ${lastPlayers[t].name}.`;
    }
    
    function witchNone() {
      database.ref(`rooms/${currentRoom}/actions/night_${phase.night}/witch/none`).set(true);
    }
    
    function hunterShoot() {
      const t = document.getElementById('hunterTarget').value;
      database.ref(`rooms/${currentRoom}/actions/night_${phase.night}/hunter`).set({ shooter: myPlayerId, target: t });
    }

    function toggleRoleVisibility() {
      rolesVisible = !rolesVisible;
      database.ref(`rooms/${currentRoom}/players`).once('value', (snap) => updatePlayerUI(snap.val()));
    }

    function toggleLife(pid, currentStatus) {
      database.ref(`rooms/${currentRoom}/players/${pid}/status`).set(currentStatus === "ALIVE" ? "DEAD" : "ALIVE");
    }

    function resetGame() {
      if (confirm("Reset game? All roles and deaths will be cleared.")) {
        database.ref(`rooms/${currentRoom}/status`).set("LOBBY");
        database.ref(`rooms/${currentRoom}/players`).once('value', (snap) => {
          const players = snap.val();
          for (let id in players) {
            database.ref(`rooms/${currentRoom}/players/${id}`).update({
              role: "Waiting...",
              status: "ALIVE"
            });
          }
        });
      }
    }

    function assignRolesAndStart() {
      const hostIsPlaying = document.getElementById('hostIsPlaying').checked;
      database.ref(`rooms/${currentRoom}/players`).once('value', (snap) => {
        const playersData = snap.val();
        const ids = Object.keys(playersData);
        let roles = [], poolIds = [...ids];

        if (!hostIsPlaying) {
          database.ref(`rooms/${currentRoom}/players/${myPlayerId}/role`).set("MODERATOR");
          poolIds = poolIds.filter(id => id !== myPlayerId);
        }

        for(let i=0; i<document.getElementById('wolfCount').value; i++) roles.push("WEREWOLF");
        if(document.getElementById('includeSeer').checked) roles.push("SEER");
        if(document.getElementById('includeWitch').checked) roles.push("WITCH");
        if(document.getElementById('includeHunter').checked) roles.push("HUNTER");
        while(roles.length < poolIds.length) roles.push("VILLAGER");
        
        roles.sort(() => Math.random() - 0.5);
        poolIds.forEach((id, index) => {
          database.ref(`rooms/${currentRoom}/players/${id}/role`).set(roles[index]);
        });
        database.ref(`rooms/${currentRoom}/status`).set("PLAYING");
      });
    }

    function showRole() {
        const card = document.getElementById("myRoleCard");
        card.innerText = currentRole;
        card.style.background =
            currentRole === "WEREWOLF" ? "#e94560" : "#4e9af1";
    }
    
    function hideRole() {
        const card = document.getElementById("myRoleCard");
        card.innerText = "TAP & HOLD";
        card.style.background = "#0f3460";
    }
    
    function setupRoleCardEvents() {
        const card = document.getElementById("myRoleCard");
    
        // Mouse events
        card.addEventListener("mousedown", showRole);
        card.addEventListener("mouseup", hideRole);
        card.addEventListener("mouseleave", hideRole);
    
        // Touch events
        card.addEventListener("touchstart", showRole);
        card.addEventListener("touchend", hideRole);
        card.addEventListener("touchcancel", hideRole);
    }
    
    window.addEventListener("load", setupRoleCardEvents);

    function leaveGame() {
      if (confirm("Leave game?")) {
        database.ref(`rooms/${currentRoom}/players/${myPlayerId}`).remove();
        localStorage.clear(); location.reload();
      }
    }
  </script>
</body>
</html>
