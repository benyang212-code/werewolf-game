<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Werewolf Pro - Persistence & Audio</title>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  
  <style>
    body { background: #1a1a2e; color: white; font-family: sans-serif; text-align: center; margin: 0; padding: 20px; transition: background 2s; }
    .hidden { display: none !important; }
    .panel { background: #16213e; padding: 20px; border-radius: 15px; max-width: 450px; margin: 20px auto; border: 1px solid #4e9af1; position: relative; }
    input, select { padding: 10px; border-radius: 5px; border: none; margin: 10px 0; width: 80%; background: #0f3460; color: white; }
    button { padding: 12px 24px; cursor: pointer; background: #e94560; color: white; border: none; border-radius: 5px; font-weight: bold; margin: 5px; transition: 0.2s; }
    .player-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #0f3460; font-size: 0.9rem; }
    .leave-btn { background: #555; font-size: 0.7rem; position: absolute; top: 10px; right: 10px; padding: 5px 10px; }
    #roomBadge { font-size: 2.5rem; color: #4e9af1; font-weight: bold; letter-spacing: 5px; margin: 10px 0; }
    .card { width: 180px; height: 260px; background: #0f3460; border: 3px solid #e94560; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin: 20px auto; cursor: pointer; }
    .night-mode { background: #000000 !important; }
  </style>
</head>
<body>

  <button id="leaveBtn" class="leave-btn hidden" onclick="leaveGame()">Leave Game</button>

  <div id="landingPanel" class="panel">
    <h1>WEREWOLF</h1>
    <button onclick="createGame()">Create New Game</button>
    <hr style="border: 0; border-top: 1px solid #4e9af1; margin: 20px 0;">
    <input type="text" id="joinCode" placeholder="Enter 4-Letter Code">
    <button onclick="joinGame()">Join Game</button>
  </div>

  <div id="lobbyPanel" class="panel hidden">
    <p>Room Code:</p>
    <div id="roomBadge">----</div>
    
    <div id="hostControls" class="hidden">
      <h3>Game Settings</h3>
      <label>Werewolves: </label>
      <select id="wolfCount">
        <option value="1">1</option><option value="2">2</option><option value="3">3</option>
      </select>
      <div style="text-align: left; margin: 10px 20%; font-size: 0.9rem;">
        <label><input type="checkbox" id="includeSeer" checked> Seer</label><br>
        <label><input type="checkbox" id="includeWitch" checked> Witch</label><br>
        <label><input type="checkbox" id="includeHunter" checked> Hunter</label>
      </div>
      <button onclick="assignRolesAndStart()">DEAL ROLES & START</button>
    </div>

    <div id="playerStatus" class="hidden">
      <h3>Waiting for host...</h3>
    </div>

    <hr style="border: 0; border-top: 1px solid #4e9af1;">
    <div id="playerList"></div>
  </div>

  <div id="gamePanel" class="panel hidden">
    <h2 id="gameStatus">Your Role</h2>
    <div class="card" id="myRoleCard" onclick="revealRoleOnCard()">TAP TO REVEAL</div>
    <p id="roleDesc">Keep it secret!</p>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCjdJYEjdZb-5OQxyBYSfXxVD9y5aaCh64",
  authDomain: "werewolfgame-7386c.firebaseapp.com",
  databaseURL: "https://werewolfgame-7386c-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "werewolfgame-7386c",
  storageBucket: "werewolfgame-7386c.firebasestorage.app",
  messagingSenderId: "37154052928",
  appId: "1:37154052928:web:ea8671e645f8cbf62038a5",
  measurementId: "G-1VYE9RRKVJ"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let currentRoom = null;
    let myPlayerId = null;
    let isHost = false;
    let currentRole = "Unknown";
    let heartbeatInterval;

    window.onload = () => {
      const savedRoom = localStorage.getItem('werewolf_room');
      const savedId = localStorage.getItem('werewolf_id');
      if (savedRoom && savedId) {
        database.ref(`rooms/${savedRoom}`).once('value', (snap) => {
          if (snap.exists()) {
            currentRoom = savedRoom;
            myPlayerId = savedId;
            setupListeners(savedRoom);
          } else {
            localStorage.clear();
          }
        });
      }
    };

    function playHeartbeat() {
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      heartbeatInterval = setInterval(() => {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = 'sine';
        osc.frequency.setValueAtTime(60, audioCtx.currentTime);
        gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.5);
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        osc.stop(audioCtx.currentTime + 0.5);
      }, 1000);
    }

    function createGame() {
      const code = Math.random().toString(36).substring(2, 6).toUpperCase();
      const name = prompt("Enter your name:");
      if (!name) return;
      isHost = true;
      database.ref('rooms/' + code).set({ status: "LOBBY" }).then(() => {
        addPlayerToRoom(code, name);
        document.getElementById('hostControls').classList.remove('hidden');
      });
    }

    function joinGame() {
      const code = document.getElementById('joinCode').value.toUpperCase();
      const name = prompt("Enter your name:");
      if (!name || !code) return;
      database.ref('rooms/' + code).once('value', (snap) => {
        if (snap.exists()) {
          addPlayerToRoom(code, name);
          document.getElementById('playerStatus').classList.remove('hidden');
        } else {
          alert("Room not found!");
        }
      });
    }

    function addPlayerToRoom(code, name) {
      currentRoom = code;
      const playersRef = database.ref('rooms/' + code + '/players');
      
      // Fix: Get count first, then add player to ensure Seat 1
      playersRef.once('value', (snap) => {
        const seatNum = (snap.numChildren() || 0) + 1;
        const playerRef = playersRef.push();
        myPlayerId = playerRef.key;
        
        localStorage.setItem('werewolf_room', code);
        localStorage.setItem('werewolf_id', myPlayerId);

        playerRef.set({ name: name, seat: seatNum, role: "Waiting..." });
        setupListeners(code);
      });
    }

    function setupListeners(code) {
      showLobby(code);
      database.ref('rooms/' + code + '/players').on('value', (snap) => {
        updatePlayerList(snap.val());
      });

      database.ref('rooms/' + code + '/status').on('value', (snap) => {
        if (snap.val() === "PLAYING") {
          database.ref('rooms/' + code + '/players/' + myPlayerId + '/role').once('value', (rSnap) => {
            currentRole = rSnap.val();
            showGame();
            document.body.classList.add('night-mode');
            playHeartbeat();
          });
        }
      });
    }

    function updatePlayerList(players) {
      const listDiv = document.getElementById('playerList');
      listDiv.innerHTML = "<h4>Players Joined:</h4>";
      for (let id in players) {
        listDiv.innerHTML += `<div class="player-row">
          <span>Seat ${players[id].seat}</span>
          <span>${players[id].name}</span>
        </div>`;
      }
    }

    function showLobby(code) {
      document.getElementById('landingPanel').classList.add('hidden');
      document.getElementById('lobbyPanel').classList.remove('hidden');
      document.getElementById('leaveBtn').classList.remove('hidden');
      document.getElementById('roomBadge').innerText = code;
    }

    function assignRolesAndStart() {
      database.ref('rooms/' + currentRoom + '/players').once('value', (snap) => {
        const playersData = snap.val();
        const playerIds = Object.keys(playersData);
        let roles = [];
        const wolves = parseInt(document.getElementById('wolfCount').value);
        for(let i=0; i<wolves; i++) roles.push("WEREWOLF");
        if(document.getElementById('includeSeer').checked) roles.push("SEER");
        if(document.getElementById('includeWitch').checked) roles.push("WITCH");
        if(document.getElementById('includeHunter').checked) roles.push("HUNTER");
        while(roles.length < playerIds.length) roles.push("VILLAGER");
        
        roles.sort(() => Math.random() - 0.5);
        playerIds.forEach((id, index) => {
          database.ref('rooms/' + currentRoom + '/players/' + id + '/role').set(roles[index]);
        });
        database.ref('rooms/' + currentRoom + '/status').set("PLAYING");
      });
    }

    function showGame() {
      document.getElementById('lobbyPanel').classList.add('hidden');
      document.getElementById('gamePanel').classList.remove('hidden');
    }

    function revealRoleOnCard() {
      const card = document.getElementById('myRoleCard');
      card.innerText = currentRole;
      card.style.background = (currentRole === "WEREWOLF") ? "#e94560" : "#4e9af1";
    }

    function leaveGame() {
      if (confirm("Leave this game?")) {
        clearInterval(heartbeatInterval);
        database.ref('rooms/' + currentRoom + '/players/' + myPlayerId).remove();
        localStorage.clear();
        location.reload();
      }
    }
  </script>
</body>
</html>
