<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Werewolf Pro - Night Edition</title>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-database-compat.js"></script>
  
  <style>
    body { background: #1a1a2e; color: white; font-family: sans-serif; text-align: center; margin: 0; padding: 20px; transition: background 1s; }
    .hidden { display: none !important; }
    .panel { background: #16213e; padding: 20px; border-radius: 15px; max-width: 450px; margin: 20px auto; border: 1px solid #4e9af1; position: relative; }
    input, select { padding: 10px; border-radius: 5px; border: none; margin: 10px 0; width: 80%; background: #0f3460; color: white; }
    button { padding: 12px 24px; cursor: pointer; background: #e94560; color: white; border: none; border-radius: 5px; font-weight: bold; margin: 5px; }
    
    #roomSticky { position: fixed; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 5px 15px; border-radius: 20px; border: 1px solid #4e9af1; font-size: 0.8rem; z-index: 100; }
    .leave-btn { background: #555; font-size: 0.7rem; position: fixed; top: 10px; right: 10px; padding: 8px 15px; border-radius: 20px; z-index: 100; }
    
    .player-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #0f3460; font-size: 0.9rem; }
    .dead { text-decoration: line-through; color: #ff4d6d !important; opacity: 0.6; }
    
    .card { width: 180px; height: 260px; background: #0f3460; border: 3px solid #e94560; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; margin: 20px auto; cursor: pointer; }
    .night-mode { background: #050510 !important; }
    
    /* NEW STYLES FOR NIGHT PHASE */
    #timerDisplay { font-size: 4rem; font-weight: bold; color: #e94560; margin: 10px 0; text-shadow: 0 0 10px #e94560; }
    #phaseName { font-size: 1.2rem; color: #4e9af1; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 5px; }
    .active-turn { border: 4px solid #4e9af1 !important; box-shadow: 0 0 20px #4e9af1; transform: scale(1.02); transition: 0.3s; }
    
    .host-btn-group { display: flex; flex-wrap: wrap; justify-content: center; gap: 5px; margin-top: 10px; }
    .btn-secondary { background: #4e9af1; font-size: 0.8rem; }
    .btn-danger { background: #555; font-size: 0.8rem; }
    .btn-night { background: #8e44ad; width: 100%; margin-bottom: 10px; font-size: 1rem; }
  </style>
</head>
<body>

  <div id="roomSticky" class="hidden">ROOM: <span id="stickyCode">----</span></div>
  <button id="leaveBtn" class="leave-btn hidden" onclick="leaveGame()">LEAVE</button>

  <div id="landingPanel" class="panel">
    <h1>WEREWOLF</h1>
    <button onclick="createGame()">Create New Game</button>
    <hr style="border: 0; border-top: 1px solid #4e9af1; margin: 20px 0;">
    <input type="text" id="joinCode" placeholder="Enter 4-Letter Code">
    <button onclick="joinGame()">Join Game</button>
  </div>

  <div id="lobbyPanel" class="panel hidden">
    <h2>LOBBY</h2>
    <div id="roomBadge" style="font-size: 2rem; color: #4e9af1; letter-spacing: 3px;">----</div>
    
    <div id="hostControls" class="hidden">
      <div style="text-align: left; display: inline-block; margin: 15px 0;">
        <label>Wolves: <select id="wolfCount" style="width: 50px;"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></label><br>
        <label><input type="checkbox" id="includeSeer" checked> Seer</label><br>
        <label><input type="checkbox" id="includeWitch" checked> Witch</label><br>
        <label><input type="checkbox" id="includeHunter" checked> Hunter</label><br>
        <label><input type="checkbox" id="hostIsPlaying" checked> Host is Playing</label>
      </div><br>
      <button onclick="assignRolesAndStart()">DEAL & START</button>
    </div>

    <div id="playerStatus" class="hidden"><h3>Waiting for host...</h3></div>
    <hr style="border: 0; border-top: 1px solid #4e9af1;">
    <div id="playerList"></div>
  </div>

  <div id="gamePanel" class="panel hidden">
    <div id="nightHeader" class="hidden">
      <div id="phaseName">Night Phase</div>
      <div id="timerDisplay">00</div>
    </div>

    <div id="roleView">
      <h2 id="gameStatus">Your Role</h2>
      <div class="card" id="myRoleCard" onclick="revealRoleOnCard()">TAP TO REVEAL</div>
    </div>

    <div id="deadMessage" class="hidden">
      <h1 style="color: #e94560;">YOU ARE DEAD</h1>
    </div>
    
    <div id="hostDashboard" class="hidden">
      <hr>
      <h3>Host Tools</h3>
      <button class="btn-night" onclick="startNightSequence()">ðŸŒ™ START NIGHT FALL</button>
      
      <div class="host-btn-group">
        <button class="btn-secondary" onclick="toggleRoleVisibility()">Show/Hide Secret Roles</button>
        <button class="btn-danger" onclick="resetGame()">Reset Room</button>
      </div>
      <div id="hostPlayerList" style="margin-top: 15px;"></div>
    </div>
  </div>

  <script>
    // --- FIREBASE CONFIG ---
    const firebaseConfig = {
      apiKey: "AIzaSyCjdJYEjdZb-5OQxyBYSfXxVD9y5aaCh64",
      authDomain: "werewolfgame-7386c.firebaseapp.com",
      databaseURL: "https://werewolfgame-7386c-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "werewolfgame-7386c",
      storageBucket: "werewolfgame-7386c.firebasestorage.app",
      messagingSenderId: "37154052928",
      appId: "1:37154052928:web:ea8671e645f8cbf62038a5",
      measurementId: "G-1VYE9RRKVJ"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let currentRoom = null, myPlayerId = null, isHost = false, currentRole = "Unknown", rolesVisible = false;
    let timerInterval = null;

    // --- NEW: Voice Helper ---
    function announce(text) {
      if ('speechSynthesis' in window) {
        window.speechSynthesis.cancel(); // Stop previous
        const msg = new SpeechSynthesisUtterance(text);
        msg.rate = 0.9; 
        msg.pitch = 0.8; // Lower pitch for dramatic effect
        window.speechSynthesis.speak(msg);
      }
    }

    window.onload = () => {
      const savedRoom = localStorage.getItem('werewolf_room');
      const savedId = localStorage.getItem('werewolf_id');
      const savedHost = localStorage.getItem('werewolf_isHost');
      if (savedRoom && savedId) {
        currentRoom = savedRoom; myPlayerId = savedId;
        isHost = (savedHost === "true");
        setupListeners(savedRoom);
      }
    };

    function createGame() {
      const code = Math.random().toString(36).substring(2, 6).toUpperCase();
      const name = prompt("Enter host name:");
      if (!name) return;
      isHost = true; localStorage.setItem('werewolf_isHost', "true");
      // Added nightPhase: "IDLE" to initial state
      database.ref('rooms/' + code).set({ status: "LOBBY", nightPhase: "IDLE" }).then(() => addPlayerToRoom(code, name));
    }

    function joinGame() {
      const code = document.getElementById('joinCode').value.toUpperCase();
      const name = prompt("Enter your name:");
      if (!name || !code) return;
      database.ref('rooms/' + code).once('value', (snap) => {
        if (snap.exists()) addPlayerToRoom(code, name);
        else alert("Room not found!");
      });
    }

    function addPlayerToRoom(code, name) {
      currentRoom = code;
      const playersRef = database.ref('rooms/' + code + '/players');
      playersRef.once('value', (snap) => {
        const seatNum = (snap.numChildren() || 0) + 1;
        const playerRef = playersRef.push();
        myPlayerId = playerRef.key;
        localStorage.setItem('werewolf_room', code);
        localStorage.setItem('werewolf_id', myPlayerId);
        playerRef.set({ name: name, seat: seatNum, role: "Waiting...", status: "ALIVE" });
        setupListeners(code);
      });
    }

    function setupListeners(code) {
      document.getElementById('roomBadge').innerText = code;
      document.getElementById('stickyCode').innerText = code;
      document.getElementById('roomSticky').classList.remove('hidden');
      document.getElementById('landingPanel').classList.add('hidden');
      document.getElementById('leaveBtn').classList.remove('hidden');

      database.ref('rooms/' + code).on('value', (snap) => {
        const data = snap.val();
        if (!data) return;

        if (data.status === "LOBBY") {
          document.getElementById('lobbyPanel').classList.remove('hidden');
          document.getElementById('gamePanel').classList.add('hidden');
          document.body.classList.remove('night-mode');
          if (isHost) document.getElementById('hostControls').classList.remove('hidden');
          else document.getElementById('playerStatus').classList.remove('hidden');
        } else {
          // GAME PHASE
          document.getElementById('lobbyPanel').classList.add('hidden');
          document.getElementById('gamePanel').classList.remove('hidden');
          document.body.classList.add('night-mode');
          if (isHost) document.getElementById('hostDashboard').classList.remove('hidden');
          
          const me = data.players[myPlayerId];
          currentRole = me.role;

          // --- NEW: Handle Night UI & Timer ---
          handleNightPhase(data.nightPhase, data.phaseEndTime);

          if (me.status === "DEAD") {
            document.getElementById('roleView').classList.add('hidden');
            document.getElementById('deadMessage').classList.remove('hidden');
          } else {
            document.getElementById('roleView').classList.toggle('hidden', me.role === "MODERATOR");
            document.getElementById('deadMessage').classList.add('hidden');
          }
        }
        updatePlayerUI(data.players);
      });
    }

    // --- NEW: Night Logic Function ---
    function handleNightPhase(phase, endTime) {
      const timerDisplay = document.getElementById('timerDisplay');
      const header = document.getElementById('nightHeader');
      const phaseName = document.getElementById('phaseName');
      const myCard = document.getElementById('myRoleCard');

      // Clear previous timer
      if (timerInterval) clearInterval(timerInterval);

      if (!phase || phase === "IDLE") {
        header.classList.add('hidden');
        myCard.classList.remove('active-turn');
        return;
      }

      // Show Timer UI
      header.classList.remove('hidden');
      phaseName.innerText = phase.replace('_', ' ') + " TURN";
      
      // Highlight my card if it is my turn
      if (currentRole === "WEREWOLF" && phase === "WEREWOLVES") {
        myCard.classList.add('active-turn');
      } else if (currentRole === phase) {
        myCard.classList.add('active-turn');
      } else {
        myCard.classList.remove('active-turn');
      }

      // Start Countdown
      timerInterval = setInterval(() => {
        const now = Date.now();
        const diff = Math.ceil((endTime - now) / 1000);
        
        if (diff >= 0) {
          timerDisplay.innerText = diff < 10 ? "0" + diff : diff;
        } else {
          timerDisplay.innerText = "00";
          clearInterval(timerInterval);
        }
      }, 1000);
    }

    // --- NEW: Sequence Automation (Host Only) ---
    async function startNightSequence() {
      if(!confirm("Start automated night sequence?")) return;

      // 1. Start Night
      announce("Night falls. Everyone please close your eyes.");
      
      // 2. Wolves (60s)
      await setPhase("WEREWOLVES", 60); 
      announce("Werewolves, wake up.");

      // 3. Seer (30s) - Triggered after 60s
      setTimeout(async () => {
        announce("Werewolves sleep. Seer, wake up.");
        await setPhase("SEER", 30);
      }, 62000); // Small buffer for transition

      // 4. Witch (30s)
      setTimeout(async () => {
        announce("Seer sleep. Witch, wake up.");
        await setPhase("WITCH", 30);
      }, 93000);

      // 5. Hunter (3s)
      setTimeout(async () => {
        announce("Witch sleep. Hunter, wake up.");
        await setPhase("HUNTER", 3);
      }, 124000);

      // 6. End Night
      setTimeout(async () => {
        announce("Hunter sleep. The sun rises. Everyone wake up.");
        database.ref('rooms/' + currentRoom).update({ nightPhase: "IDLE" });
      }, 128000);
    }

    function setPhase(role, seconds) {
      const endTime = Date.now() + (seconds * 1000);
      return database.ref('rooms/' + currentRoom).update({
        nightPhase: role,
        phaseEndTime: endTime
      });
    }

    function updatePlayerUI(players) {
      const listDiv = document.getElementById('playerList');
      const hostDiv = document.getElementById('hostPlayerList');
      listDiv.innerHTML = "<h4>Players Joined:</h4>";
      hostDiv.innerHTML = "";

      for (let id in players) {
        const p = players[id];
        listDiv.innerHTML += `<div class="player-row ${p.status === 'DEAD' ? 'dead' : ''}">
          <span>Seat ${p.seat}: ${p.name}</span>
        </div>`;

        if (isHost) {
          const roleDisplay = rolesVisible ? p.role : "???";
          hostDiv.innerHTML += `<div class="player-row">
            <span>${p.name} (${roleDisplay})</span>
            <button class="btn-secondary" style="padding:5px;" onclick="toggleLife('${id}', '${p.status}')">
              ${p.status === 'ALIVE' ? 'Kill' : 'Revive'}
            </button>
          </div>`;
        }
      }
    }

    function toggleRoleVisibility() {
      rolesVisible = !rolesVisible;
      database.ref(`rooms/${currentRoom}/players`).once('value', (snap) => updatePlayerUI(snap.val()));
    }

    function toggleLife(pid, currentStatus) {
      database.ref(`rooms/${currentRoom}/players/${pid}/status`).set(currentStatus === "ALIVE" ? "DEAD" : "ALIVE");
    }

    function resetGame() {
      if (confirm("Reset game? All roles and deaths will be cleared.")) {
        database.ref(`rooms/${currentRoom}`).update({ status: "LOBBY", nightPhase: "IDLE" });
        database.ref(`rooms/${currentRoom}/players`).once('value', (snap) => {
          const players = snap.val();
          for (let id in players) {
            database.ref(`rooms/${currentRoom}/players/${id}`).update({
              role: "Waiting...",
              status: "ALIVE"
            });
          }
        });
      }
    }

    function assignRolesAndStart() {
      const hostIsPlaying = document.getElementById('hostIsPlaying').checked;
      database.ref(`rooms/${currentRoom}/players`).once('value', (snap) => {
        const playersData = snap.val();
        const ids = Object.keys(playersData);
        let roles = [], poolIds = [...ids];

        if (!hostIsPlaying) {
          database.ref(`rooms/${currentRoom}/players/${myPlayerId}/role`).set("MODERATOR");
          poolIds = poolIds.filter(id => id !== myPlayerId);
        }

        for(let i=0; i<document.getElementById('wolfCount').value; i++) roles.push("WEREWOLF");
        if(document.getElementById('includeSeer').checked) roles.push("SEER");
        if(document.getElementById('includeWitch').checked) roles.push("WITCH");
        if(document.getElementById('includeHunter').checked) roles.push("HUNTER");
        while(roles.length < poolIds.length) roles.push("VILLAGER");
        
        roles.sort(() => Math.random() - 0.5);
        poolIds.forEach((id, index) => {
          database.ref(`rooms/${currentRoom}/players/${id}/role`).set(roles[index]);
        });
        database.ref(`rooms/${currentRoom}/status`).set("PLAYING");
        database.ref(`rooms/${currentRoom}/nightPhase`).set("IDLE");
      });
    }

    function revealRoleOnCard() {
      const card = document.getElementById('myRoleCard');
      card.innerText = currentRole;
      card.style.background = (currentRole === "WEREWOLF") ? "#e94560" : "#4e9af1";
    }

    function leaveGame() {
      if (confirm("Leave game?")) {
        database.ref(`rooms/${currentRoom}/players/${myPlayerId}`).remove();
        localStorage.clear(); location.reload();
      }
    }
  </script>
</body>
</html>
